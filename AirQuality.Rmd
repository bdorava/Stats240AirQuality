---
title: "Air Pollution and Lake Breeze"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = TRUE,
                      error = TRUE)
library(readxl)
library(tidyverse)
library(lubridate)
library(viridisLite)
library(kableExtra)
source("scripts/viridis.R")
source("scripts/ggprob.R")
```

```{r label='Extract and clean data', include=FALSE}
#### Ground Data ####
full_data = read_excel("data/2021Chiwaukee.xls", skip=2) %>% 
  full_join(read_excel("data/2022Chiwaukee.xlsx", skip=2)) %>% #Join both years of air quality data
  rename(timestamp = "Monitor Name", 
         ozone = "OZONE",
         atemp = "T_OUTDOOR",
         wspeed = "WIND SPEED - R", 
         wdir = "WIND DIRECTION - R",
         precip = "RAIN/MELT PCPT",
         solar = "SOLAR RADIATION",
         pm25 = "PM2.5 - LC",
         noy = "NOy",
         co = "CARBON MONOXIDE") %>% #Rename columns
  select(timestamp, ozone, atemp, wspeed,
         wdir, precip, solar, pm25, noy, co) %>% #Select useful columns
  filter(timestamp != "Units" &
         timestamp != "Parameter Code | POC" &
         timestamp != "Tag Number" &
         timestamp != "Minimum" &
         timestamp != "MinDate" &
         timestamp != "Maximum" &
         timestamp != "MaxDate" &
         timestamp != "Avg" &
         timestamp != "Num" &
         timestamp != "Data[%]" &
         timestamp != "STD") %>% #Remove Padding
  mutate(.,
         ozone = case_when(str_detect(.$ozone, "[A-Za-z]") ~ NA,
                                     .default = ozone),
         atemp = case_when(str_detect(.$atemp, "[A-Za-z]") ~ NA,
                                     .default = atemp),
         wspeed = case_when(str_detect(.$wspeed, "[A-Za-z]") ~ NA,
                                     .default = wspeed),
         wdir = case_when(str_detect(.$wdir, "[A-Za-z]") ~ NA,
                                     .default = wdir),
         precip = case_when(str_detect(.$precip, "[A-Za-z]") ~ NA,
                                     .default = precip),
         solar = case_when(str_detect(.$solar, "[A-Za-z]") ~ NA,
                                     .default = solar),
         pm25 = case_when(str_detect(.$pm25, "[A-Za-z]") ~ NA,
                                     .default = pm25),
         noy = case_when(str_detect(.$noy, "[A-Za-z]") ~ NA,
                                     .default = noy),
         co = case_when(str_detect(.$co, "[A-Za-z]") ~ NA,
                                     .default = co)) %>% #Remove missing values
  mutate(timestamp = mdy_hm(timestamp),
         ozone = round(as.numeric(ozone), 1),
         atemp = round(as.numeric(atemp), 1),
         wspeed = round(as.numeric(wspeed), 1),
         wdir = round(as.integer(wdir)),
         precip = round(as.numeric(precip), 1),
         solar = round(as.numeric(solar), 1),
         pm25 = round(as.numeric(pm25), 1),
         noy = round(as.numeric(noy), 1),
         co = round(as.numeric(co), 3)) %>% #Convert types
  mutate(atemp = (atemp - 32) / 1.8, wspeed = wspeed * 1609.344 / 3600) %>% #Convert to metric
  mutate(year = year(timestamp),
         month = month(timestamp, label = TRUE),
         wday = wday(timestamp, label = TRUE), 
         day = day(timestamp),
         hour = hour(timestamp),
         minute = minute(timestamp)) %>% 
  mutate(u = round(-wspeed * sin(wdir*2*pi/360), 2),
         v = round(-wspeed * cos(wdir*2*pi/360), 2)) %>% #Determine components of 2-D flow, from wdir
  drop_na(wspeed, wdir) %>% #Drop rows with missing data
  mutate(xbin = round(u),
         ybin = round(v))
```

This is an example of lake breeze, characterized by drop in land temperature, shifting wind direction, increased ozone levels.
```{r}
breeze_example_year = 2022
breeze_example_month = "May"
breeze_example_day = 19

breeze_example = full_data %>%
  filter(year == breeze_example_year,
         month == breeze_example_month,
         day == breeze_example_day)

ggplot() +
  geom_point(aes(x = timestamp, y = atemp, color = ozone),
             breeze_example,
             shape = "square") +
  geom_text(aes(x = timestamp, y = atemp-.5, angle = -wdir, size = wspeed),
            breeze_example,
            label = "↓",
            color = "red",
            check_overlap = T)
```

# Introduction



## Background

1.8 miles away, North-west of buoy

## Analysis



## Discussion



## References

In the R Markdown file, you may automatically cite other resources by using a caret followed by the reference between square brackets: ^[your reference text] which will place a marker at this location and a footnote at the end of the document.


###############################################################
##Testing ground, cell below will not evaluate when knitting.##
###############################################################

```{r}
full_data %>%
  drop_na(ozone) %>%
  ggplot() + geom_point(aes(x=u, y=v, color=ozone))

grouped_data = full_data %>%
  drop_na(ozone) %>%
  group_by(xbin, ybin) %>%
  summarise(mean_ozone = mean(ozone),
            median_ozone = median(ozone),
            sd_ozone = sd(ozone),
            n_ozone = n())

grouped_data %>%
  ggplot() +
  geom_tile(aes(x = xbin, y = ybin, fill = mean_ozone)) +
  geom_point(aes(x=u, y=v, color=ozone), full_data %>%
               drop_na(ozone), size = 0.2) #Sanity check to see the data points are in bins
```


```{r}
grouped_data %>%
  ggplot() + geom_tile(aes(x = xbin, y = ybin, fill = median_ozone)) + 
  geom_text(aes(x = xbin, y = ybin, label = n_ozone, size = 1/n_ozone)) #Numbered samples
data_nw_center = grouped_data %>%
    filter(((-0.5 < xbin & xbin < 2.5 & -1.5 < ybin & ybin < 1.5)) | ((-2.5 < xbin & xbin < 0.5 & 1.5 < ybin & ybin < 4.5)))


# Perform Welch's t-test
t_test_result_q1 = t.test(data_nw_center$mean_ozone[data_nw_center$xbin < 0], 
                          data_nw_center$mean_ozone[data_nw_center$xbin >= 0], 
                          alternative = "two.sided", 
                          var.equal = FALSE)

# Print the test result
t_test_result_q1

# Filter data for the northeast and center bins
data_nw_ne = grouped_data %>%
  filter(((-0.5 < xbin & xbin < 2.5 & 1.5 < ybin & ybin < 4.5)) | ((-2.5 < xbin & xbin < 0.5 & 1.5 < ybin & ybin < 4.5)))

# Perform Welch's t-test
t_test_result_q2 = t.test(data_nw_ne$mean_ozone[data_nw_ne$xbin < 0], 
                          data_nw_ne$mean_ozone[data_nw_ne$xbin >= 0], 
                          alternative = "two.sided", 
                          var.equal = FALSE)

# Print the test result
t_test_result_q2

grouped_data %>%
  ggplot() + geom_tile(aes(x = xbin, y = ybin, fill = median_ozone, alpha = n_ozone)) #Visual representation of sample size. Very low ozone counts when wind is calm

grouped_data %>%
  ggplot() + geom_tile(aes(x = xbin, y = ybin, fill = sd_ozone)) + 
  geom_text(aes(x = xbin, y = ybin, label = n_ozone, size = 1/n_ozone))
grouped_data %>%
  ggplot() + geom_tile(aes(x = xbin, y = ybin, fill = median_ozone, alpha = n_ozone)) #Very low ozone counts when wind is calm
grouped_data %>%
  ggplot() + geom_tile(aes(x = xbin, y = ybin, fill = sd_ozone)) #Increased variance when u < 0 and v > 0, greatest variance near u = -1, v = 4

full_data %>%
  drop_na(ozone) %>%
  filter(xbin == -1, ybin == 4) %>%
  select(year, month, day) %>%
  group_by(year, month, day) %>%
  unique() #Days with favorable wind conditions
```


```{r, eval=FALSE}
full_data %>%
  ggplot(aes(x = day, y = u)) + geom_point() + facet_grid(vars(month), vars(year), scales = "free") + scale_color_viridis_c(direction = -1)


full_data %>%
  filter(month == "Aug" & day <= 7) %>%
  ggplot(aes(x = hour, y = solar, color = wday)) + geom_smooth() + geom_point() + facet_grid(vars(year), scales = "free") + scale_color_viridis_d(direction = -1, option = "D")


full_data %>%
  #filter(source == "water") %>%
  ggplot(aes(x = timestamp, y = u)) + geom_point(alpha = 0.5, size = 0.1)
```


```{r}
full_data %>%
  filter(month == "Jun" & year == "2021") %>%
  ggplot(aes(x = timestamp, y = u, color = ozone)) + geom_point()
```

```{r}
full_data %>%
  #filter(u < 0) %>%
  filter(year == 2021, month == "Jun", day == 3) %>%
  ggplot(.) + geom_point(aes(x = hour, y = atemp, color = ozone)) + geom_text(aes(x = hour, y = atemp-.5, angle = -wdir, color = ozone, size = wspeed), label = "↓")
```

```{r}
full_data %>%
  group_by(wday, high_wind) %>%
  drop_na(ozone) %>%
  summarise(mean_ozone = mean(ozone))
```

```{r}
full_data %>%
  arrange(desc(wspeed), timestamp) %>%
  drop_na(ozone) %>%
  ggplot(aes(x=wdir, y=wspeed, color=ozone)) + geom_point()

x = full_data %>%
  filter(wdir > 140, wdir < 200) %>%
  select(ozone) %>%
  drop_na()

y = full_data %>%
  filter(wdir > 250, wdir < 310) %>%
  select(ozone) %>%
  drop_na()

t.test(x, y)
```

