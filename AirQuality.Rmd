---
title: "Air Pollutant Transport Along Lake Michigan"
author: "Benjamin Dorava, Sanjay Murali, Akshat Jain"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = TRUE,
                      error = TRUE)
library(readxl)
library(tidyverse)
library(lubridate)
library(viridisLite)
library(kableExtra)
library(latex2exp)
source("scripts/viridis.R")
source("scripts/ggprob.R")
```

```{r label='extract and clean data', include=FALSE}
#### Ground Data ####
full_data = read_excel("data/2021Chiwaukee.xls", skip=2) %>% 
  full_join(read_excel("data/2022Chiwaukee.xlsx", skip=2)) %>% #Join both years of air quality data
  rename(timestamp = "Monitor Name", 
         ozone = "OZONE",
         atemp = "T_OUTDOOR",
         wspeed = "WIND SPEED - R", 
         wdir = "WIND DIRECTION - R",
         precip = "RAIN/MELT PCPT",
         solar = "SOLAR RADIATION",
         pm25 = "PM2.5 - LC",
         noy = "NOy",
         co = "CARBON MONOXIDE") %>% #Rename columns
  select(timestamp, ozone, atemp, wspeed,
         wdir, precip, solar, pm25, noy, co) %>% #Select useful columns
  filter(timestamp != "Units" &
         timestamp != "Parameter Code | POC" &
         timestamp != "Tag Number" &
         timestamp != "Minimum" &
         timestamp != "MinDate" &
         timestamp != "Maximum" &
         timestamp != "MaxDate" &
         timestamp != "Avg" &
         timestamp != "Num" &
         timestamp != "Data[%]" &
         timestamp != "STD") %>% #Remove Padding
  mutate(.,
         ozone = case_when(str_detect(.$ozone, "[A-Za-z]") ~ NA,
                                     .default = ozone),
         atemp = case_when(str_detect(.$atemp, "[A-Za-z]") ~ NA,
                                     .default = atemp),
         wspeed = case_when(str_detect(.$wspeed, "[A-Za-z]") ~ NA,
                                     .default = wspeed),
         wdir = case_when(str_detect(.$wdir, "[A-Za-z]") ~ NA,
                                     .default = wdir),
         precip = case_when(str_detect(.$precip, "[A-Za-z]") ~ NA,
                                     .default = precip),
         solar = case_when(str_detect(.$solar, "[A-Za-z]") ~ NA,
                                     .default = solar),
         pm25 = case_when(str_detect(.$pm25, "[A-Za-z]") ~ NA,
                                     .default = pm25),
         noy = case_when(str_detect(.$noy, "[A-Za-z]") ~ NA,
                                     .default = noy),
         co = case_when(str_detect(.$co, "[A-Za-z]") ~ NA,
                                     .default = co)) %>% #Remove missing values
  mutate(timestamp = mdy_hm(timestamp),
         ozone = round(as.numeric(ozone), 1),
         atemp = round(as.numeric(atemp), 1),
         wspeed = round(as.numeric(wspeed), 1),
         wdir = round(as.integer(wdir)),
         precip = round(as.numeric(precip), 1),
         solar = round(as.numeric(solar), 1),
         pm25 = round(as.numeric(pm25), 1),
         noy = round(as.numeric(noy), 1),
         co = round(as.numeric(co), 3)) %>% #Convert types
  mutate(atemp = (atemp - 32) / 1.8, wspeed = wspeed * 1609.344 / 3600) %>% #Convert to metric
  mutate(year = year(timestamp),
         month = month(timestamp, label = TRUE),
         wday = wday(timestamp, label = TRUE), 
         day = day(timestamp),
         hour = hour(timestamp),
         minute = minute(timestamp)) %>% 
  mutate(u = round(-wspeed * sin(wdir*2*pi/360), 2),
         v = round(-wspeed * cos(wdir*2*pi/360), 2)) %>% #Determine components of 2-D flow, from wdir
  drop_na(wspeed, wdir) %>% #Drop rows with missing data
  mutate(xbin = round(u),
         ybin = round(v)) #Add bins to generalize flow
```

```{r TODO, include=FALSE}
grouped_data = full_data %>%
  drop_na(ozone) %>%
  group_by(xbin, ybin) %>%
  summarise(mean_ozone = mean(ozone),
            median_ozone = median(ozone),
            sd_ozone = sd(ozone),
            n_ozone = n())
```

```{r initialize_plots, include=FALSE}
ozone_plot = full_data %>%
  drop_na(ozone) %>%
  ggplot() +
  geom_point(aes(x=u, y=v, color=ozone)) +
  labs(title = "Figure 1",
       subtitle = "Ozone Concentration With Respect to Wind Velocity Components",
       color = "Ozone Concentration (ppb)",
       x = TeX("Zonal Component of Velocity (${ms}^{-1}$)"),
       y = TeX("Meridional Component of Velocity (${ms}^{-1}$)"))

mean_ozone_plot = grouped_data %>% #Mean Ozone, Numbered Samples
  ggplot() + geom_tile(aes(x = xbin, y = ybin, fill = mean_ozone)) + 
  geom_text(aes(x = xbin, y = ybin, label = n_ozone, size = 1/n_ozone)) +
  labs(title = "Figure 2",
       subtitle = "Mean Ozone Concentration Within 1m/s Bins\nWith Respect to Wind Velocity Components\n(Numbers Indicate Sample Size Within Each Bin)",
       fill = "Ozone Concentration\nMean (ppb)",
       x = TeX("Zonal Component of Velocity (${ms}^{-1}$)"),
       y = TeX("Meridional Component of Velocity (${ms}^{-1}$)")) +
  guides(size=F) +
  geom_rect(xmin = -0.5,
            xmax = 2.5,
            ymin = -1.5,
            ymax = 1.5,
            color = "gold",
            alpha = 0) +
  geom_rect(xmin = -2.5,
            xmax = 0.5,
            ymin = 1.5,
            ymax = 4.5,
            color = "red",
            alpha = 0,
            linetype = "dotted") +
  geom_rect(xmin = -0.5,
            xmax = 2.5,
            ymin = 1.5,
            ymax = 4.5,
            color = "red",
            alpha = 0,
            linetype = "dashed") +
  geom_rect(xmin = -2.5,
            xmax = 0.5,
            ymin = -1.5,
            ymax = -4.5,
            color = "red",
            alpha = 0,
            linetype = "dotted") +
  geom_rect(xmin = -0.5,
            xmax = 2.5,
            ymin = -1.5,
            ymax = -4.5,
            color = "red",
            alpha = 0,
            linetype = "dashed")

sd_ozone_plot = grouped_data %>% #SD Ozone, Numbered Samples
  ggplot() + geom_tile(aes(x = xbin, y = ybin, fill = sd_ozone)) + 
  geom_text(aes(x = xbin, y = ybin, label = n_ozone, size = 1/n_ozone)) +
  labs(title = "Figure 3",
       subtitle = "Standard Deviation of Ozone Concentrations Within 1m/s Bins\nWith Respect to Wind Velocity Components\n(Numbers Indicate Sample Size Within Each Bin)",
       fill = "Ozone Concentration\nStandard Deviation (ppb)",
       x = TeX("Zonal Component of Velocity (${ms}^{-1}$)"),
       y = TeX("Meridional Component of Velocity ${ms}^{-1}$")) +
  guides(size=F)


breeze_example_year = 2022
breeze_example_month = "May"
breeze_example_day = 19

breeze_example = full_data %>%
  filter(year == breeze_example_year,
         month == breeze_example_month,
         day == breeze_example_day)

breeze_example_plot = ggplot() + #Lake Breeze Example
  geom_point(aes(x = timestamp, y = atemp, color = ozone),
             breeze_example,
             shape = "square") +
  geom_text(aes(x = timestamp, y = atemp-.5, angle = -wdir, size = wspeed),
            breeze_example,
            label = "↓",
            color = "red",
            check_overlap = T) +
  labs(title = "Figure 4",
       subtitle = "(Arrows Indicate Direction and Relative Magnitude of Wind)",
       color = "Ozone Concentration (ppb)",
       x = "Time",
       y = "Air Temperature (°C)") +
  guides(size=F)
```
## Introduction

Air pollution has detrimental impacts on community health, especially for vulnerable populations. Some of these impacts can be mitigated by issuing air quality advisories, which are informed by predictions of atmospheric flow.

We are interested in analyzing air quality monitoring data from a fixed location 40 miles north of downtown Chicago, and seek to investigate possible correlations between wind velocity and ozone concentrations.

From our analysis comparing mean ozone concentrations between samples of similar wind velocity, we find that there is a positive correlation between north-westward blowing wind and ozone concentration.

## Background

One source of air pollutants—such as ozone and its precursors—is automobiles. The increased concentration of automobiles within cities predictably means that ozone concentrations are typically greater than in rural areas. This investigation is interested in the effects of wind as it transports ozone from urban towards rural areas.

The Wisconsin Department of Natural Resources maintains several air quality monitoring sites across the state. The data set we analyze consists of two consecutive years of seasonally reported ozone concentrations and meteorological conditions measured by the Chiwaukee Prairie Stateline station (AQS: 55-059-0019).

This station records ozone concentrations  during March through October, and data was available for 2021–2022.^[https://wi-dnr.widencollective.com/portals/iwvftorq/iwvftorq/AirMonitoringData/c/feee5d04-93b9-4362-9e34-6e8ff5249c5a] The station is located less than 1,000 feet from the shore of Lake Michigan in Pleasant Prairie, Kenosha, which is roughly 40 miles north of Chicago.^[https://dnr.wisconsin.gov/sites/default/files/topic/AirQuality/Draft2024AnnualNetworkPlan.pdf]

We are interested in 3 variables: zonal and meridional components of flow, and ozone concentration. The zonal (meridional) component of flow, conventionally written as $u$ ($v$) refers to the magnitude of the wind vector in the $\hat{i}$ ($\hat{j}$) direction; in other words, the portion of the wind blowing purely in the direction of west-to-east (south-to-north). These components of flow are determined trigonometrically from the reported wind speed and direction, and are in units of ${ms}^{-1}$. Ozone concentration is reported in units of parts per billion ($ppb$).

## Analysis

```{r display_ozone_plot, echo=FALSE}
ozone_plot
```

```{r display_mean_ozone_plot, echo=FALSE}
mean_ozone_plot
```

```{r display_sd_ozone_plot, echo=FALSE}
sd_ozone_plot
```

```{r}
data_nw_center = grouped_data %>% #TODO Change to full data
    filter(((-0.5 < xbin & xbin < 2.5 & -1.5 < ybin & ybin < 1.5)) | ((-2.5 < xbin & xbin < 0.5 & 1.5 < ybin & ybin < 4.5)))


# Perform Welch's t-test
t_test_result_q1 = t.test(data_nw_center$mean_ozone[data_nw_center$xbin < 0], 
                          data_nw_center$mean_ozone[data_nw_center$xbin >= 0], 
                          alternative = "two.sided", 
                          var.equal = FALSE)

# Print the test result
t_test_result_q1

# Filter data for the northeast and center bins
data_nw_ne = grouped_data %>%
  filter(((-0.5 < xbin & xbin < 2.5 & 1.5 < ybin & ybin < 4.5)) | ((-2.5 < xbin & xbin < 0.5 & 1.5 < ybin & ybin < 4.5)))

# Perform Welch's t-test
t_test_result_q2 = t.test(data_nw_ne$mean_ozone[data_nw_ne$xbin < 0], 
                          data_nw_ne$mean_ozone[data_nw_ne$xbin >= 0], 
                          alternative = "two.sided", 
                          var.equal = FALSE)

# Print the test result
t_test_result_q2


# Hypothesis test for q3
  q3data = grouped_data %>%
    filter(((-2.5 < xbin & xbin < 0.5 & 1.5 < ybin & ybin < 4.5)) | ((-2.5 < xbin & xbin < 0.5 & -4.5 < ybin & ybin < 1.5)))
q3_testresult = t.test(q3data$mean_ozone[q3data$xbin < 0], 
                          q3data$mean_ozone[q3data$xbin >= 0], 
                          alternative = "two.sided")
q3_testresult
# Hypothesis test for q4
  q4data = grouped_data %>%
    filter(((-2.5 < xbin & xbin < 0.5 & 1.5 < ybin & ybin < 4.5)) | ((-0.5 < xbin & xbin < 2.5 & -4.5 < ybin & ybin < 1.5)))
q4_testresult = t.test(q4data$mean_ozone[q4data$xbin < 0], 
                          q4data$mean_ozone[q4data$xbin >= 0], 
                          alternative = "two.sided")
q4_testresult
```

## Discussion

This is an example of lake breeze, characterized by drop in land temperature, shifting wind direction, increased ozone levels.

```{r display_breeze_example_plot, echo=FALSE}
breeze_example_plot
```


## References